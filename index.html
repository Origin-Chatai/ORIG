  </style>
</head>
<body>
  <a href="https://raw.githubusercontent.com/Origin-Chatai/ORIG/6b5e3e332ce1fba4d60df66c520e6c0f64e77ade/1.svg" target="_blank" style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
    <img src="https://krseoul.imgtbl.com/i/2024/12/03/674f1ae8990e3.png" alt="Top Logo" style="width: 107px; height: 30px;">
  </a>
  <button id="connectWalletButton">Connect Wallet</button>
  <div class="container">
    <div class="logo">
      <img src="https://krseoul.imgtbl.com/i/2024/12/03/674f1ae87452f.gif" alt="Logo">
    </div>
    <div class="chat-container" id="chatContainer"></div>
    <input type="text" id="chatInput" placeholder="Please enter a message..." />
    <button id="chatSendButton">SEND</button>
  </div>
  <div class="bottom-links">
    <a href="https://t.me/+nsJGUiFYqpY5MTdl" target="_blank">
      <img src="https://krseoul.imgtbl.com/i/2024/12/03/674f1ae8c10ea.png" alt="Page 1">
    </a>
    <a href="https://t.me/+nsJGUiFYqpY5MTdl" target="_blank">
      <img src="https://krseoul.imgtbl.com/i/2024/12/03/674f1ae8ce660.png" alt="Page 2">
    </a>
  </div>
  <script>

  </script>
</body>

<script>
  const chatContainer = document.getElementById('chatContainer');
  const chatInput = document.getElementById('chatInput');
  const chatSendButton = document.getElementById('chatSendButton');
  const connectWalletButton = document.getElementById('connectWalletButton');

  let OPENAI_API_KEY = ''; // 将通过 fetch 动态加载
  const userAvatar = 'https://krseoul.imgtbl.com/i/2024/12/03/674f1ae8c240b.png'; 
  const botAvatar = 'https://krseoul.imgtbl.com/i/2024/12/03/674f248a7219b.png'; 
  let replyCount = 0; 
  let walletConnected = false; 

  // 1. 动态加载API密钥
  async function loadApiKey() {
    try {
      const response = await fetch('/config.json');
      const config = await response.json();
      OPENAI_API_KEY = config.OPENAI_API_KEY;
    } catch (error) {
      console.error('加载API密钥失败:', error);
      displayChatBubble('无法加载API密钥，请联系管理员。', 'bot');
    }
  }

  async function sendChatMessage(message) {
    if (replyCount >= 10 && !walletConnected) {
      displayChatBubble('请连接钱包后继续使用聊天功能。', 'bot');
      return;
    }

    if (replyCount === 0) {
      displayChatBubble('请稍等，正在建立通信...', 'bot');
    }

    displayChatBubble(message, 'user');

    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'You are a helpful assistant.' },
            { role: 'user', content: message },
          ],
        }),
      });

      const data = await response.json();
      const botResponse = data.choices[0].message.content || '抱歉，发生错误。';

      displayChatBubble(botResponse, 'bot');
      replyCount++; 
    } catch (err) {
      displayChatBubble('发生错误，无法生成回复。', 'bot');
      console.error(err);
    }
  }

  function displayChatBubble(message, sender) {
    const chatMessage = document.createElement('div');
    chatMessage.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
    
    const avatar = document.createElement('img');
    avatar.src = sender === 'user' ? userAvatar : botAvatar;
    
    const bubble = document.createElement('div');
    bubble.classList.add('chat-bubble');
    bubble.textContent = message;
    
    chatMessage.appendChild(avatar);
    chatMessage.appendChild(bubble);
    chatContainer.appendChild(chatMessage);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  async function connectToPhantomWallet() {
    if (window.solana && window.solana.isPhantom) {
      try {
        const response = await window.solana.connect();
        console.log('Wallet connected:', response.publicKey.toString());

        const message = "请签名此消息以验证身份。";
        const encodedMessage = new TextEncoder().encode(message);
        const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');

        console.log('签名消息:', signedMessage.signature);
        walletConnected = true;
        displayChatBubble(`钱包已连接！您的公钥: ${response.publicKey.toString()}`, 'bot');
      } catch (err) {
        console.error('连接失败:', err);
        displayChatBubble('连接失败，请确认是否安装了Phantom钱包。', 'bot');
      }
    } else {
      console.warn('Phantom Wallet未安装！');
      displayChatBubble('请使用Google Chrome上的Phantom Wallet插件或Phantom App内浏览器绑定钱包。', 'bot');
    }
  }

  connectWalletButton.addEventListener('click', () => {
    connectToPhantomWallet();
  });

  chatSendButton.addEventListener('click', () => {
    const message = chatInput.value.trim();
    if (message) {
      sendChatMessage(message);
      chatInput.value = '';
    }
  });

  chatInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      const message = chatInput.value.trim();
      if (message) {
        sendChatMessage(message);
        chatInput.value = '';
      }
    }
  });

  // 初始化时加载API密钥
  loadApiKey();
</script>
</body>
</html>
